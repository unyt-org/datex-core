on:
    pull_request:
        types: [opened, reopened, edited, synchronize]
    workflow_dispatch:
        inputs:
            reason:
                description: 'Reason for running benchmarks'
                required: false
                default: 'Manual trigger'

jobs:
    benchmark_pr_branch:
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true
        name: Continuous Benchmarking PRs
        # Skip for feature branches, only run for release branches or manual triggers
        if: >
            (github.event_name == 'workflow_dispatch') || 
            (github.event_name == 'pull_request' && 
             github.event.pull_request.head.repo.full_name == github.repository &&
             !startsWith(github.head_ref, 'feature/'))
        permissions:
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - name: Cache dependencies
              uses: actions/cache@v4
              env:
                  cache-name: cache-dependencies
              with:
                  path: |
                      ~/.cargo/.crates.toml
                      ~/.cargo/.crates2.json
                      ~/.cargo/bin
                      ~/.cargo/registry/index
                      ~/.cargo/registry/cache
                      target
                  key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('Cargo.lock') }}
            - uses: bencherdev/bencher@main
            - name: Install Dependencies
              run: |
                  sudo apt update
                  sudo apt install libudev-dev pkg-config
            - name: Track PR Benchmarks with Bencher
              run: |
                  bencher run \
                  --project datex-core \
                  --token '${{ secrets.BENCHER_API_TOKEN }}' \
                  --branch "$GITHUB_HEAD_REF" \
                  --start-point main \
                  --start-point-clone-thresholds \
                  --start-point-reset \
                  --testbed ubuntu-latest \
                  --err \
                  --adapter rust_criterion \
                  --github-actions '${{ secrets.GITHUB_TOKEN }}' \
                  cargo bench
